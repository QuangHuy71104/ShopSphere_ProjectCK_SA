<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ShopSphere Demo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root {
  --accent: #0f9eb9;
  --bg: #f5fbff;
  --panel: #ffffff;
  --border: #d7e2e8;
  --muted: #6b7b87;
  font-family: "Inter","Segoe UI",system-ui,sans-serif;
  color: #0f172a;
}
*{box-sizing:border-box;}
body{margin:0;padding:0;background:var(--bg);}
.wrap{max-width:1200px;margin:0 auto;padding:28px 16px 40px;}
.hero{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:18px 18px 14px;box-shadow:0 8px 18px rgba(0,0,0,0.05);}
h1{margin:0 0 6px;font-size:26px;letter-spacing:-0.02em;}
p.lead{margin:0;color:var(--muted);}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:14px;margin-top:16px;}
.card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 8px 18px rgba(0,0,0,0.05);}
.card h3{margin:0 0 8px;font-size:17px;}
label{display:block;margin:8px 0 4px;font-size:13px;color:var(--muted);}
input,select{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#fdfefe;color:#0f172a;}
input:focus,select:focus{outline:1px solid var(--accent);border-color:var(--accent);background:#fff;}
button{padding:10px 14px;border:0;border-radius:12px;background:var(--accent);color:#ffffff;font-weight:700;cursor:pointer;box-shadow:0 8px 16px rgba(15,158,185,0.2);}
button:hover{filter:brightness(1.03);}
.btn-ghost{background:#e6f3f7;color:#0f172a;box-shadow:none;}
.flex{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;}
.badge{display:inline-flex;align-items:center;gap:6px;padding:5px 10px;border-radius:999px;background:#e6f7fa;color:#0f172a;font-size:12px;font-weight:700;}
.badge.off{background:#e5e7eb;color:var(--muted);}
.small{color:var(--muted);font-size:13px;}
.cards-sm{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px;}
pre{background:#0f172a;color:#e2e8f0;padding:10px;border-radius:12px;overflow:auto;border:1px solid rgba(255,255,255,0.05);}
.toast{position:fixed;bottom:18px;right:18px;background:var(--accent);color:#fff;padding:12px 14px;border-radius:12px;box-shadow:0 10px 24px rgba(15,158,185,0.35);opacity:0;transform:translateY(12px);transition:.25s ease;}
.toast.error{background:#ef4444;}
.toast.show{opacity:1;transform:translateY(0);}
.table{width:100%;border-collapse:collapse;}
.table th,.table td{padding:8px 6px;border-bottom:1px solid var(--border);text-align:left;}
.table th{color:var(--muted);font-size:13px;}
.input-eye{position:relative;}
.input-eye input{padding-right:42px;}
.eye-btn{position:absolute;top:50%;right:8px;transform:translateY(-50%);border:0;background:transparent;cursor:pointer;padding:4px;display:flex;align-items:center;justify-content:center;color:#475569;}
.eye-btn:hover{color:#0f172a;}
</style>
</head>
<body>
<div class="wrap">
  <div class="hero">
    <h1>ShopSphere Demo</h1>
    <p class="lead">Login (admin/staff/buyer), manage categories/products and try checkout.</p>
  </div>

  <div class="grid">
    <section class="card" id="auth">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
        <h3>Đăng nhập</h3>
        <span class="badge off" id="roleBadge">Chưa đăng nhập</span>
      </div>
      <div class="flex">
        <div style="flex:1" id="usernameBlock"><label>Username</label><input id="u" value="admin"></div>
        <div style="flex:1" id="passwordBlock"><label>Password</label>
          <div class="input-eye">
            <input id="p" type="password" value="">
            <button type="button" id="eyeBtn" class="eye-btn" aria-label="Toggle password visibility">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7Z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
            </button>
          </div>
        </div>
        <div id="loginButtonBlock"><button id="loginBtn" onclick="login()">Login</button></div>
        <div><button class="btn-ghost" onclick="logout()">Logout</button></div>
      </div>
      <div class="small" style="margin-top:8px;">Token (JWT):</div>
      <pre id="tokenBox">Chưa đăng nhập</pre>
    </section>

    <section class="card" id="catSection">
      <h3>Danh mục</h3>
      <div class="flex">
        <div style="flex:1"><label>Tên</label><input id="catName" placeholder="Category name"></div>
        <div><button onclick="createCategory()">Tạo (Admin/Staff)</button></div>
      </div>
      <div style="margin-top:10px;"><button class="btn-ghost" onclick="loadCategories()">Tải danh sách</button></div>
      <div id="catList" class="cards-sm" style="margin-top:10px;"></div>
    </section>

    <section class="card" id="prodSection">
      <h3>Sản phẩm</h3>
      <div class="flex">
        <div style="flex:1"><label>Tên</label><input id="prodName" placeholder="Product name"></div>
        <div style="width:120px"><label>Giá</label><input id="prodPrice" type="number" step="0.01" value="10"></div>
        <div style="width:100px"><label>Stock</label><input id="prodStock" type="number" value="5"></div>
      </div>
      <div class="flex" style="margin-top:8px">
        <div style="flex:1"><label>CategoryId</label><input id="prodCatId" placeholder="Dán Id danh mục"></div>
        <div><button onclick="createProduct()">Tạo (Admin/Staff)</button></div>
      </div>
      <div class="flex" style="margin-top:10px">
        <div style="flex:1"><label>Tìm kiếm</label><input id="qSearch" placeholder="text"></div>
        <div style="flex:1"><label>Sắp xếp</label>
          <select id="qSort">
            <option value="">(none)</option>
            <option value="price_asc">price_asc</option>
            <option value="price_desc">price_desc</option>
            <option value="newest">newest</option>
          </select>
        </div>
        <div style="flex:1"><label>CategoryId filter</label><input id="qCat" placeholder="CategoryId"></div>
        <div><button class="btn-ghost" onclick="loadProducts()">Tải sản phẩm</button></div>
      </div>
      <div style="margin-top:10px;overflow:auto;max-height:220px;">
        <table class="table">
          <thead><tr><th>Tên</th><th>Giá</th><th>Stock</th><th>Category</th></tr></thead>
          <tbody id="prodTable"></tbody>
        </table>
      </div>
    </section>

    <section class="card" id="checkoutSection">
      <h3>Checkout / Payment</h3>
      <div class="flex">
        <div style="flex:1"><label>Buyer Email</label><input id="buyerEmail" value="buyer@mail.com"></div>
        <div style="flex:1"><label>Product</label><select id="checkoutProduct"></select></div>
        <div style="width:110px"><label>Qty</label><input id="checkoutQty" type="number" min="1" value="1"></div>
        <div style="width:140px"><label>Price</label><input id="amount" type="number" step="0.01" value="0" readonly></div>
        <div><button onclick="checkout()">Start checkout</button></div>
      </div>
      <div class="flex" style="margin-top:8px">
        <div style="flex:1"><label>OrderId</label><input id="orderId" readonly placeholder="Tự điền sau khi checkout"></div>
        <div><button class="btn-ghost" onclick="confirm()">Confirm</button></div>
        <div><button class="btn-ghost" onclick="fail()">Fail</button></div>
      </div>
      <div class="small" style="margin-top:8px;">Kết quả:</div>
      <pre id="checkoutBox">Chưa chạy</pre>
    </section>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
const api = window.location.origin;
let token = null;
let products = [];
let categories = [];
let currentOrderId = null;
const roleBadge = document.getElementById("roleBadge");
const toastEl = document.getElementById("toast");
const tokenBox = document.getElementById("tokenBox");
const checkoutProductSelect = document.getElementById("checkoutProduct");
const checkoutQtyInput = document.getElementById("checkoutQty");
const amountInput = document.getElementById("amount");
const orderIdInput = document.getElementById("orderId");
const usernameInput = document.getElementById("u");
const passwordInput = document.getElementById("p");
const eyeBtn = document.getElementById("eyeBtn");
const usernameBlock = document.getElementById("usernameBlock");
const passwordBlock = document.getElementById("passwordBlock");
const loginButtonBlock = document.getElementById("loginButtonBlock");
const catSection = document.getElementById("catSection");
const prodSection = document.getElementById("prodSection");
const checkoutSection = document.getElementById("checkoutSection");

function isGuid(value){
  return /^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(value.trim());
}

function showToast(msg, isError=false){
  toastEl.textContent = msg;
  toastEl.classList.toggle("error", isError);
  toastEl.classList.add("show");
  setTimeout(()=>toastEl.classList.remove("show"), 2200);
}

function toggleDataSections(show){
  const display = show ? "block" : "none";
  [catSection, prodSection, checkoutSection].forEach(el=>{
    if(el) el.style.display = display;
  });
}

function toggleLoginForm(show){
  const display = show ? "" : "none";
  [usernameBlock, passwordBlock, loginButtonBlock].forEach(el=>{
    if(el) el.style.display = display;
  });
}

function setToken(data){
  if(data?.accessToken){
    token = data.accessToken;
    localStorage.setItem("ss_token", token);
    roleBadge.textContent = data.role || "cached";
    roleBadge.classList.remove("off");
    tokenBox.textContent = JSON.stringify(data, null, 2);
    toggleDataSections(true);
    toggleLoginForm(false);
    // After successful login, load data
    loadCategories();
    loadProducts();
  } else {
    token = null;
    localStorage.removeItem("ss_token");
    roleBadge.textContent = "Chưa đăng nhập";
    roleBadge.classList.add("off");
    tokenBox.textContent = "Chưa đăng nhập";
    toggleDataSections(false);
    toggleLoginForm(true);
    // Clear data views
    catList.innerHTML = "<div class=\"small\">Vui lòng đăng nhập để xem danh mục</div>";
    prodTable.innerHTML = "<tr><td colspan='4'>Vui lòng đăng nhập để xem sản phẩm</td></tr>";
    products = [];
    categories = [];
    renderCheckoutProducts();
  }
}

async function request(path, opts={}){
  const headers = opts.headers || {};
  headers["Content-Type"] = "application/json";
  if(token) headers["Authorization"] = "Bearer " + token;
  const res = await fetch(api + path, { ...opts, headers });
  if(!res.ok){
    const txt = await res.text();
    throw new Error(res.status + " " + res.statusText + ": " + txt);
  }
  if(res.status === 204) return null;
  return res.json();
}

async function login(){
  try{
    const body = { username: u.value, password: p.value };
    const data = await request("/v1/auth/login", { method:"POST", body: JSON.stringify(body) });
    setToken(data);
    showToast("Đăng nhập thành công (" + data.role + ")");
  } catch(e){ showToast(e.message, true); }
}
function logout(){ setToken(null); showToast("Đã logout"); }

async function loadCategories(){
  if(!token){ catList.innerHTML="<div class=\"small\">Vui lòng đăng nhập</div>"; return; }
  catList.innerHTML = "Loading...";
  try{
    const data = await request(`/v1/categories?page=1&pageSize=30`);
    categories = data.items || [];
    catList.innerHTML = "";
    categories.forEach(c=>addCategoryCard(c));
  } catch(e){ catList.innerHTML=e; }
}

function addCategoryCard(c, prepend=false){
  const div=document.createElement("div");
  div.className="card";
  div.style.padding="10px";
  div.style.cursor="pointer";
  div.innerHTML=`<strong>${c.name}</strong><br><span class="small">${c.id}</span>`;
  div.onclick=()=>{ prodCatId.value=c.id; showToast("Đã chọn CategoryId"); };
  if(prepend && catList.firstChild){
    catList.insertBefore(div, catList.firstChild);
  } else {
    catList.appendChild(div);
  }
}

async function createCategory(){
  try{
    const c = await request("/v1/categories",{method:"POST",body:JSON.stringify({name:catName.value})});
    catName.value="";
    categories.unshift(c);
    addCategoryCard(c, true);
    showToast("Tạo danh mục OK");
  } catch(e){ showToast(e.message,true); }
}

function renderCheckoutProducts(){
  checkoutProductSelect.innerHTML = "";
  products.forEach(p=>{
    const opt=document.createElement("option");
    opt.value=p.id;
    opt.textContent=`${p.name}`;
    checkoutProductSelect.appendChild(opt);
  });
  updateCheckoutAmount();
}

function updateCheckoutAmount(){
  const pid = checkoutProductSelect.value;
  const qty = Math.max(1, Number(checkoutQtyInput.value)||1);
  checkoutQtyInput.value = qty;
  const prod = products.find(p=>p.id===pid);
  const price = prod ? prod.price : 0;
  amountInput.value = (price * qty).toFixed(2);
}

async function loadProducts(){
  if(!token){ prodTable.innerHTML="<tr><td colspan='4'>Vui lòng đăng nhập</td></tr>"; return; }
  prodTable.innerHTML="<tr><td colspan='4'>Loading...</td></tr>";
  try{
    const params=new URLSearchParams({page:1,pageSize:30});
    if(qSearch.value) params.append("search", qSearch.value);
    if(qSort.value) params.append("sort", qSort.value);
    if(qCat.value) params.append("categoryId", qCat.value);
    const data=await request("/v1/products?"+params.toString());
    products = data.items;
    prodTable.innerHTML="";
    products.forEach(p=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${p.name}</td><td>$${p.price}</td><td>${p.stock}</td><td class="small">${p.categoryId}</td>`;
      prodTable.appendChild(tr);
    });
    renderCheckoutProducts();
  } catch(e){ prodTable.innerHTML=`<tr><td colspan='4'>${e}</td></tr>`; }
}

async function createProduct(){
  const categoryId = prodCatId.value.trim();
  if(!categoryId) return showToast("Nhập CategoryId hoặc chọn từ danh sách ở thẻ Danh mục", true);
  if(!isGuid(categoryId)) return showToast("CategoryId không hợp lệ. Nhấn \"Tải danh sách\" và bấm vào danh mục để tự điền ID.", true);
  try{
    await request("/v1/products",{method:"POST",body:JSON.stringify({
      name:prodName.value,
      price:Number(prodPrice.value),
      stock:Number(prodStock.value),
      categoryId
    })});
    prodName.value="";
    showToast("Tạo sản phẩm OK");
    loadProducts();
  } catch(e){ showToast(e.message,true); }
}

async function checkout(){
  if(!token) return showToast("Vui lòng đăng nhập", true);
  checkoutBox.textContent="Đang tạo...";
  try{
    const productId = checkoutProductSelect.value;
    const quantity = Math.max(1, Number(checkoutQtyInput.value)||1);
    const data=await request("/v1/orders/checkout",{method:"POST",body:JSON.stringify({
      buyerEmail:buyerEmail.value,
      productId,
      quantity
    })});
    currentOrderId = data.orderId;
    orderIdInput.value = data.orderId;
    checkoutBox.textContent=JSON.stringify(data,null,2);
    showToast("Checkout created");
    await loadProducts(); // refresh stock
  } catch(e){ checkoutBox.textContent=e; showToast(e.message,true); }
}

async function confirm(){
  if(!token) return showToast("Vui lòng đăng nhập", true);
  if(!currentOrderId) return showToast("Chưa có OrderId",true);
  try{
    const data=await request(`/v1/orders/${currentOrderId}/payment/confirm`,{method:"POST"});
    checkoutBox.textContent=JSON.stringify(data,null,2);
    showToast("Payment confirmed");
  } catch(e){ checkoutBox.textContent=e; showToast(e.message,true); }
}

async function fail(){
  if(!token) return showToast("Vui lòng đăng nhập", true);
  if(!currentOrderId) return showToast("Chưa có OrderId",true);
  try{
    const data=await request(`/v1/orders/${currentOrderId}/payment/fail`,{method:"POST",body:JSON.stringify("Manual fail")});
    checkoutBox.textContent=JSON.stringify(data,null,2);
    showToast("Payment failed");
  } catch(e){ checkoutBox.textContent=e; showToast(e.message,true); }
}

checkoutProductSelect?.addEventListener("change", updateCheckoutAmount);
checkoutQtyInput?.addEventListener("input", updateCheckoutAmount);
eyeBtn?.addEventListener("click", ()=>{
  if(!passwordInput) return;
  const isHidden = passwordInput.type === "password";
  passwordInput.type = isHidden ? "text" : "password";
  eyeBtn.innerHTML = isHidden
    ? '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>'
    : '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-6.94"></path><path d="M9.88 9.88a3 3 0 0 0 4.24 4.24"></path><path d="M1 1l22 22"></path></svg>';
});
[usernameInput, passwordInput].forEach(el=>{
  el?.addEventListener("keydown", (e)=>{
    if(e.key === "Enter"){
      e.preventDefault();
      login();
    }
  });
});

// Do not auto-load data; wait for login
toggleDataSections(!!token);
setToken(null); // force logged-out state on first load (ignore cached tokens)
</script>
</body>
</html>
