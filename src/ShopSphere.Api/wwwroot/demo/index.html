<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ShopSphere Demo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root {
  --accent: #0f9eb9;
  --bg: #f7fbfd;
  --panel: #ffffff;
  --border: #d7e2e8;
  --muted: #6b7b87;
  font-family: "Inter","Segoe UI",system-ui,sans-serif;
  color: #0f172a;
}
*{box-sizing:border-box;}
body{margin:0;padding:0;background:var(--bg);}
.wrap{max-width:1200px;margin:0 auto;padding:28px 16px 40px;}
.hero{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:18px 18px 14px;box-shadow:0 8px 18px rgba(0,0,0,0.05);}
h1{margin:0 0 6px;font-size:26px;letter-spacing:-0.02em;}
p.lead{margin:0;color:var(--muted);}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:14px;margin-top:16px;}
.card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 8px 18px rgba(0,0,0,0.05);}
.card h3{margin:0 0 8px;font-size:17px;}
label{display:block;margin:8px 0 4px;font-size:13px;color:var(--muted);}
input,select{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#fdfefe;color:#0f172a;}
input:focus,select:focus{outline:1px solid var(--accent);border-color:var(--accent);background:#fff;}
button{padding:10px 14px;border:0;border-radius:12px;background:var(--accent);color:#ffffff;font-weight:700;cursor:pointer;box-shadow:0 8px 16px rgba(15,158,185,0.2);}
button:hover{filter:brightness(1.03);}
.btn-ghost{background:#e6f3f7;color:#0f172a;box-shadow:none;}
.flex{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;}
.badge{display:inline-flex;align-items:center;gap:6px;padding:5px 10px;border-radius:999px;background:#e6f7fa;color:#0f172a;font-size:12px;font-weight:700;}
.badge.off{background:#e5e7eb;color:var(--muted);}
.small{color:var(--muted);font-size:13px;}
.cards-sm{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px;}
pre{background:#0f172a;color:#e2e8f0;padding:10px;border-radius:12px;overflow:auto;border:1px solid rgba(255,255,255,0.05);}
.toast{position:fixed;bottom:18px;right:18px;background:var(--accent);color:#fff;padding:12px 14px;border-radius:12px;box-shadow:0 10px 24px rgba(15,158,185,0.35);opacity:0;transform:translateY(12px);transition:.25s ease;}
.toast.error{background:#ef4444;}
.toast.show{opacity:1;transform:translateY(0);}
.table{width:100%;border-collapse:collapse;}
.table th,.table td{padding:8px 6px;border-bottom:1px solid var(--border);text-align:left;}
.table th{color:var(--muted);font-size:13px;}
</style>
</head>
<body>
<div class="wrap">
  <div class="hero">
    <h1>ShopSphere Demo</h1>
    <p class="lead">Đăng nhập (admin/staff/buyer), quản lý danh mục/sản phẩm và thử checkout.</p>
  </div>

  <div class="grid">
    <section class="card" id="auth">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
        <h3>Đăng nhập</h3>
        <span class="badge off" id="roleBadge">Chưa đăng nhập</span>
      </div>
      <div class="flex">
        <div style="flex:1"><label>Username</label><input id="u" value="admin"></div>
        <div style="flex:1"><label>Password</label><input id="p" type="password" value="P@ssw0rd!"></div>
        <div><button onclick="login()">Login</button></div>
        <div><button class="btn-ghost" onclick="logout()">Logout</button></div>
      </div>
      <div class="small" style="margin-top:8px;">Token (JWT):</div>
      <pre id="tokenBox">Chưa đăng nhập</pre>
    </section>

    <section class="card">
      <h3>Danh mục</h3>
      <div class="flex">
        <div style="flex:1"><label>Tên</label><input id="catName" placeholder="Category name"></div>
        <div><button onclick="createCategory()">Tạo (Admin/Staff)</button></div>
      </div>
      <div style="margin-top:10px;"><button class="btn-ghost" onclick="loadCategories()">Tải danh sách</button></div>
      <div id="catList" class="cards-sm" style="margin-top:10px;"></div>
    </section>

    <section class="card">
      <h3>Sản phẩm</h3>
      <div class="flex">
        <div style="flex:1"><label>Tên</label><input id="prodName" placeholder="Product name"></div>
        <div style="width:120px"><label>Giá</label><input id="prodPrice" type="number" step="0.01" value="10"></div>
        <div style="width:100px"><label>Stock</label><input id="prodStock" type="number" value="5"></div>
      </div>
      <div class="flex" style="margin-top:8px">
        <div style="flex:1"><label>CategoryId</label><input id="prodCatId" placeholder="Dán Id danh mục"></div>
        <div><button onclick="createProduct()">Tạo (Admin/Staff)</button></div>
      </div>
      <div class="flex" style="margin-top:10px">
        <div style="flex:1"><label>Tìm kiếm</label><input id="qSearch" placeholder="text"></div>
        <div style="flex:1"><label>Sắp xếp</label>
          <select id="qSort">
            <option value="">(none)</option>
            <option value="price_asc">price_asc</option>
            <option value="price_desc">price_desc</option>
            <option value="newest">newest</option>
          </select>
        </div>
        <div style="flex:1"><label>CategoryId filter</label><input id="qCat" placeholder="CategoryId"></div>
        <div><button class="btn-ghost" onclick="loadProducts()">Tải sản phẩm</button></div>
      </div>
      <div style="margin-top:10px;overflow:auto;">
        <table class="table">
          <thead><tr><th>Tên</th><th>Giá</th><th>Stock</th><th>Category</th></tr></thead>
          <tbody id="prodTable"></tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <h3>Checkout / Payment</h3>
      <div class="flex">
        <div style="flex:1"><label>Buyer Email</label><input id="buyerEmail" value="buyer@mail.com"></div>
        <div style="width:140px"><label>Amount</label><input id="amount" type="number" step="0.01" value="50"></div>
        <div><button onclick="checkout()">Start checkout</button></div>
      </div>
      <div class="flex" style="margin-top:8px">
        <div style="flex:1"><label>OrderId</label><input id="orderId"></div>
        <div><button class="btn-ghost" onclick="confirm()">Confirm</button></div>
        <div><button class="btn-ghost" onclick="fail()">Fail</button></div>
      </div>
      <div class="small" style="margin-top:8px;">Kết quả:</div>
      <pre id="checkoutBox">Chưa chạy</pre>
    </section>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
const api = window.location.origin;
let token = null;
const roleBadge = document.getElementById("roleBadge");
const toastEl = document.getElementById("toast");

function showToast(msg, isError=false){
  toastEl.textContent = msg;
  toastEl.classList.toggle("error", isError);
  toastEl.classList.add("show");
  setTimeout(()=>toastEl.classList.remove("show"), 2200);
}

function setToken(data){
  if(data?.accessToken){
    token = data.accessToken;
    localStorage.setItem("ss_token", token);
    roleBadge.textContent = data.role || "cached";
    roleBadge.classList.remove("off");
    tokenBox.textContent = JSON.stringify(data, null, 2);
  } else {
    token = null;
    localStorage.removeItem("ss_token");
    roleBadge.textContent = "Chưa đăng nhập";
    roleBadge.classList.add("off");
    tokenBox.textContent = "Chưa đăng nhập";
  }
}
setToken(localStorage.getItem("ss_token") ? { accessToken: localStorage.getItem("ss_token"), role: "cached" } : null);

async function request(path, opts={}){
  const headers = opts.headers || {};
  headers["Content-Type"] = "application/json";
  if(token) headers["Authorization"] = "Bearer " + token;
  const res = await fetch(api + path, { ...opts, headers });
  if(!res.ok){
    const txt = await res.text();
    throw new Error(res.status + " " + res.statusText + ": " + txt);
  }
  if(res.status === 204) return null;
  return res.json();
}

async function login(){
  try{
    const body = { username: u.value, password: p.value };
    const data = await request("/v1/auth/login", { method:"POST", body: JSON.stringify(body) });
    setToken(data);
    showToast("Đăng nhập thành công (" + data.role + ")");
  } catch(e){ showToast(e.message, true); }
}
function logout(){ setToken(null); showToast("Đã logout"); }

async function loadCategories(){
  catList.innerHTML = "Loading...";
  try{
    const data = await request(`/v1/categories?page=1&pageSize=30`);
    catList.innerHTML = "";
    data.items.forEach(c=>{
      const div=document.createElement("div");
      div.className="card";
      div.style.padding="10px";
      div.style.cursor="pointer";
      div.innerHTML=`<strong>${c.name}</strong><br><span class="small">${c.id}</span>`;
      div.onclick=()=>{ prodCatId.value=c.id; showToast("Đã chọn CategoryId"); };
      catList.appendChild(div);
    });
  } catch(e){ catList.innerHTML=e; }
}

async function createCategory(){
  try{
    await request("/v1/categories",{method:"POST",body:JSON.stringify({name:catName.value})});
    catName.value="";
    showToast("Tạo danh mục OK");
    loadCategories();
  } catch(e){ showToast(e.message,true); }
}

async function loadProducts(){
  prodTable.innerHTML="<tr><td colspan='4'>Loading...</td></tr>";
  try{
    const params=new URLSearchParams({page:1,pageSize:30});
    if(qSearch.value) params.append("search", qSearch.value);
    if(qSort.value) params.append("sort", qSort.value);
    if(qCat.value) params.append("categoryId", qCat.value);
    const data=await request("/v1/products?"+params.toString());
    prodTable.innerHTML="";
    data.items.forEach(p=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${p.name}</td><td>$${p.price}</td><td>${p.stock}</td><td class="small">${p.categoryId}</td>`;
      prodTable.appendChild(tr);
    });
  } catch(e){ prodTable.innerHTML=`<tr><td colspan='4'>${e}</td></tr>`; }
}

async function createProduct(){
  try{
    await request("/v1/products",{method:"POST",body:JSON.stringify({
      name:prodName.value,
      price:Number(prodPrice.value),
      stock:Number(prodStock.value),
      categoryId:prodCatId.value
    })});
    prodName.value="";
    showToast("Tạo sản phẩm OK");
    loadProducts();
  } catch(e){ showToast(e.message,true); }
}

async function checkout(){
  checkoutBox.textContent="Đang tạo...";
  try{
    const data=await request("/v1/orders/checkout",{method:"POST",body:JSON.stringify({
      buyerEmail:buyerEmail.value,
      totalAmount:Number(amount.value)
    })});
    orderId.value=data.orderId;
    checkoutBox.textContent=JSON.stringify(data,null,2);
    showToast("Checkout created");
  } catch(e){ checkoutBox.textContent=e; showToast(e.message,true); }
}

async function confirm(){
  if(!orderId.value) return showToast("Nhập OrderId",true);
  try{
    const data=await request(`/v1/orders/${orderId.value}/payment/confirm`,{method:"POST"});
    checkoutBox.textContent=JSON.stringify(data,null,2);
    showToast("Payment confirmed");
  } catch(e){ checkoutBox.textContent=e; showToast(e.message,true); }
}

async function fail(){
  if(!orderId.value) return showToast("Nhập OrderId",true);
  try{
    const data=await request(`/v1/orders/${orderId.value}/payment/fail`,{method:"POST",body:JSON.stringify("Manual fail")});
    checkoutBox.textContent=JSON.stringify(data,null,2);
    showToast("Payment failed");
  } catch(e){ checkoutBox.textContent=e; showToast(e.message,true); }
}
</script>
</body>
</html>
